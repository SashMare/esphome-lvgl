lvgl:
  style_definitions:
    - id: roboto15_cyrillic_style
      text_font: roboto15_font

  top_layer:
    widgets:
      - label:
          text: "-° / -°"
          id: temperatures
          styles: roboto15_cyrillic_style
          align: LV_ALIGN_TOP_LEFT
          x: 8
          y: 4
          text_color: 0xFFFFFF
      - label:
          text: "--:--"
          id: display_time
          styles: roboto15_cyrillic_style
          align: LV_ALIGN_TOP_MID
          x: 0
          y: 4
          text_align: LV_TEXT_ALIGN_CENTER
          text_color: 0xFFFFFF

  pages:
    - id: main_page
      layout:
        type: flex
        flex_flow: LV_FLEX_FLOW_COLUMN_WRAP
      width: lv_pct(100)
      bg_color: black
      bg_opa: LV_OPA_COVER
      pad_top: 30
      pad_bottom: 5
      pad_left: 5
      pad_right: 5

      widgets:
        # ARC + основні дані для першої/середньої батареї
        - arc:
            id: battery_arc
            align: LV_ALIGN_TOP_MID
            width: 200
            height: 200
            rotation: 135
            min_value: 0
            max_value: 100
            value: !lambda 'return (int16_t) round(id(bat_soc)[0]);'  # або середнє по всім
            bg_color: 0x222222
            bg_opa: LV_OPA_COVER
            line_width: 35
            line_color: 0x444444
            indicator:
              arc_color: 0x00FF00

        - label:
            id: battery_soc_label
            align: LV_ALIGN_TOP_MID
            y: -50
            text_font: montserrat_48
            text_color: 0xFFFFFF
            text: !lambda |-
              char buf[10];
              snprintf(buf, sizeof(buf), "%.0f%%", id(bat_soc)[0]);
              return buf;

        # Таблиця через grid + фіксовані labels (header + 16 рядків)
        - container:
            id: battery_table_container
            align: LV_ALIGN_BOTTOM_MID
            y: -10
            width: lv_pct(95)
            height: 320
            bg_color: 0x111111
            bg_opa: LV_OPA_COVER
            border_width: 1
            border_color: 0x003366
            radius: 15
            pad_all: 8
            layout:
              type: grid
              grid_columns: [lv_pct(10), lv_pct(15), lv_pct(25), lv_pct(15), lv_pct(15), lv_pct(15), lv_pct(15)]
              grid_rows: [lv_pct(6)] * 17  # header + 16 батарей

            widgets:
              # Заголовки (рядок 0)
              - label:
                  grid_column: 0
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "#"
              - label:
                  grid_column: 1
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "SOC"
              - label:
                  grid_column: 2
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "State"
              - label:
                  grid_column: 3
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "V"
              - label:
                  grid_column: 4
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "A"
              - label:
                  grid_column: 5
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "Cycles"
              - label:
                  grid_column: 6
                  grid_row: 0
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "Temp"

              # Рядки для 16 батарей (1-16, grid_row: 1 to 16)
              - label:
                  id: row1_num
                  grid_column: 0
                  grid_row: 1
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "1"
              - label:
                  id: row1_soc
                  grid_column: 1
                  grid_row: 1
                  text_font: roboto12_cyrillic
                  text_color: 0xFFFFFF
                  text_align: LV_TEXT_ALIGN_CENTER
                  text: "-"
              # ... повторити для row1_state, row1_v, row1_a, row1_cycles, row1_temp (аналогічно для row2..row16)

              # Повтори для інших рядків (це довго, тому в реальності створюй цикл в lambda або копіюй блок 16 разів з id row2_num тощо)

  # Глобальний lambda для оновлення всіх label-ів таблиці
  - lambda:
      id: lvgl_update_table
      lambda: |-
        int count = id(module_count);
        if (count == 0) return;

        auto& data = id(bat_data);

        // Оновлення рядків
        for (int i = 0; i < 16; i++) {
          bool visible = i < count;

          // Приклад для рядка 1 (i=0)
          if (i == 0) {
            lv_obj_t *row_num = id(row1_num).obj;
            lv_obj_t *row_soc = id(row1_soc).obj;
            // ... інші labels рядка

            if (visible) {
              lv_obj_clear_flag(row_num, LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(row_soc, LV_OBJ_FLAG_HIDDEN);
              // ... для всіх

              // Заповнення з data[i]
              std::istringstream iss(data[i]);
              std::vector<std::string> fields;
              std::string field;
              while (std::getline(iss, field, ',')) fields.push_back(field);

              if (fields.size() >= 7) {
                lv_label_set_text(id(row1_num).obj, fields[0].c_str());
                lv_label_set_text(id(row1_soc).obj, fields[5].c_str());
                // ... інші поля з парсингом V/A/Temp як раніше
              }
            } else {
              lv_obj_add_flag(row_num, LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(row_soc, LV_OBJ_FLAG_HIDDEN);
              // ... ховати всі labels рядка
            }
          }
          // Повтори блок для i=1..15 з id row2_num тощо
        }      
              # ==================== Кнопка оновлення (адаптуй під uartex) ====================
              - button:
                  height: $button_height_single
                  width: $button_width
                  checkable: false
                  styles: control
                  widgets:
                    - label:
                        text_font: $icon_font
                        align: LV_ALIGN_TOP_LEFT
                        text: $battery
                    - label:
                        align: LV_ALIGN_BOTTOM_LEFT
                        text: "Оновити Pylontech"
                        text_font: roboto15_cyrillic
                  on_click:
                    - uartex.write:
                        id: pyl_uartex
                        data: "bat"
                    - delay: 3s
                    - uartex.write:
                        id: pyl_uartex
                        data: "stat"

        # ==================== Інші елементи (коридорне світло тощо) ====================
        - button:
            height: $button_height_single
            width: $button_width
            checkable: true
            id: battery_rack_light
            styles: control
            widgets:
              - label:
                  text_font: $icon_font
                  align: LV_ALIGN_TOP_LEFT
                  id: network_rack_icon
                  text: $network
              - label:
                  align: LV_ALIGN_BOTTOM_LEFT
                  id: battery_rack_label
                  text: "Battery Rack Light"
            on_click:
              - homeassistant.service:
                  service: light.toggle
                  data:
                    entity_id: light.corridor_light
