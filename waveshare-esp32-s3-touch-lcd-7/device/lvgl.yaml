lvgl:
  style_definitions:
    - id: roboto15_cyrillic_style
      text_font: roboto15_font

  top_layer:
    widgets:
      - label:
          text: "-° / -°"
          id: temperatures
          styles: roboto15_cyrillic_style
          align: LV_ALIGN_TOP_LEFT
          x: 8
          y: 4
          text_color: 0xFFFFFF
      - label:
          text: "--:--"
          id: display_time
          styles: roboto15_cyrillic_style
          align: LV_ALIGN_TOP_MID
          x: 0
          y: 4
          text_align: LV_TEXT_ALIGN_CENTER
          text_color: 0xFFFFFF

  pages:
    - id: main_page
      layout:
        type: flex
        flex_flow: LV_FLEX_FLOW_COLUMN_WRAP
      width: lv_pct(100)
      bg_color: black
      bg_opa: LV_OPA_COVER
      pad_top: 30
      pad_bottom: 5
      pad_left: 5
      pad_right: 5

      widgets:
        # ==================== ARC + загальні дані (можна залишити або видалити) ====================
        - arc:
            id: battery_arc
            align: LV_ALIGN_TOP_MID
            width: 200
            height: 200
            rotation: 135
            min_value: 0
            max_value: 100
            value: !lambda 'return (int16_t) round(id(bat_soc)[0]);'   # SOC першої батареї (або середній)
            bg_color: 0x222222
            bg_opa: LV_OPA_COVER
            line_width: 35
            line_color: 0x444444
            indicator:
              arc_color: 0x00FF00

        - label:
            id: battery_soc_label
            align: LV_ALIGN_TOP_MID
            y: -50
            text_font: montserrat_48
            text_color: 0xFFFFFF
            text: !lambda |-
              char buf[10];
              snprintf(buf, sizeof(buf), "%.0f%%", id(bat_soc)[0]);  # Перша або середній
              return buf;

        # ==================== ДИНАМІЧНА ТАБЛИЦЯ ДЛЯ 1-16 БАТАРЕЙ ====================
        - table:
            id: batt_table
            align: LV_ALIGN_BOTTOM_MID
            y: -10
            width: lv_pct(95)
            height: 320  # підбери під екран, можна динамічно
            bg_color: 0x111111
            bg_opa: LV_OPA_COVER
            border_width: 1
            border_color: 0x003366
            radius: 15
            pad_all: 8

            # Ініціалізація (create) - виконується один раз при завантаженні
            create:
              - lv_table_set_col_cnt: 7
              - lv_table_set_row_cnt: 17  # max 1 header + 16 батарей
              - lv_table_set_col_width: [0, 40]   # #
              - lv_table_set_col_width: [1, 60]   # SOC
              - lv_table_set_col_width: [2, 80]   # State
              - lv_table_set_col_width: [3, 70]   # V
              - lv_table_set_col_width: [4, 70]   # A
              - lv_table_set_col_width: [5, 80]   # Cycles
              - lv_table_set_col_width: [6, 70]   # Temp

              # Заголовки
              - lv_table_set_cell_value: [0, 0, "#"]
              - lv_table_set_cell_value: [0, 1, "SOC %"]
              - lv_table_set_cell_value: [0, 2, "State"]
              - lv_table_set_cell_value: [0, 3, "V (V)"]
              - lv_table_set_cell_value: [0, 4, "A (A)"]
              - lv_table_set_cell_value: [0, 5, "Cycles"]
              - lv_table_set_cell_value: [0, 6, "Temp °C"]

        # ==================== Оновлення таблиці (викликається після кожного парсингу) ====================
        - lambda:
            id: lvgl_update_table
            lambda: |-
              auto& data = id(bat_data);
              int count = id(module_count);
              if (count == 0) return;  // ще немає даних

              lv_table_set_row_cnt(id(batt_table), count + 1);  // header + батареї

              char buf[32];
              for (int i = 0; i < count; i++) {
                int row = i + 1;

                std::istringstream iss(data[i]);
                std::string field;
                std::vector<std::string> fields;
                while (std::getline(iss, field, ',')) {
                  fields.push_back(field);
                }

                if (fields.size() >= 7) {
                  // # (модуль)
                  lv_table_set_cell_value(id(batt_table), row, 0, fields[0].c_str());

                  // SOC %
                  lv_table_set_cell_value(id(batt_table), row, 1, fields[5].c_str());  // mod[8] з прикладу

                  // State
                  lv_table_set_cell_value(id(batt_table), row, 2, fields[4].c_str());

                  // V (перетворимо mV -> V якщо потрібно)
                  float v = std::stof(fields[1]) / 1000.0;
                  snprintf(buf, sizeof(buf), "%.2f", v);
                  lv_table_set_cell_value(id(batt_table), row, 3, buf);

                  // A
                  float a = std::stof(fields[2]) / 1000.0;
                  snprintf(buf, sizeof(buf), "%.2f", a);
                  lv_table_set_cell_value(id(batt_table), row, 4, buf);

                  // Cycles (з globals, якщо однакові для всіх, або per-module)
                  snprintf(buf, sizeof(buf), "%d", id(cycles_soh)[0]);
                  lv_table_set_cell_value(id(batt_table), row, 5, buf);

                  // Temp
                  float t = std::stof(fields[3]) / 1000.0;  // якщо в m°C
                  snprintf(buf, sizeof(buf), "%.1f", t);
                  lv_table_set_cell_value(id(batt_table), row, 6, buf);
                }
              }

        # ==================== Кнопка оновлення (адаптуй під uartex) ====================
        - button:
            height: $button_height_single
            width: $button_width
            checkable: false
            styles: control
            widgets:
              - label:
                  text_font: $icon_font
                  align: LV_ALIGN_TOP_LEFT
                  text: $battery
              - label:
                  align: LV_ALIGN_BOTTOM_LEFT
                  text: "Оновити Pylontech"
                  text_font: roboto15_cyrillic
            on_click:
              - uartex.write:
                  id: pyl_uartex
                  data: "bat"
              - delay: 3s
              - uartex.write:
                  id: pyl_uartex
                  data: "stat"

        # ==================== Інші елементи (коридорне світло тощо) ====================
        - button:
            height: $button_height_single
            width: $button_width
            checkable: true
            id: battery_rack_light
            styles: control
            widgets:
              - label:
                  text_font: $icon_font
                  align: LV_ALIGN_TOP_LEFT
                  id: network_rack_icon
                  text: $network
              - label:
                  align: LV_ALIGN_BOTTOM_LEFT
                  id: battery_rack_label
                  text: "Battery Rack Light"
            on_click:
              - homeassistant.service:
                  service: light.toggle
                  data:
                    entity_id: light.corridor_light
